package com.tss.jpa.service;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;

import com.tss.jpa.dto.StudentRequestDto;
import com.tss.jpa.dto.StudentResponseDto;
import com.tss.jpa.dto.StudentResponsePage;
import com.tss.jpa.entity.Student;
import com.tss.jpa.repository.StudentRepository;

@Service
public class StudentServiceImpl implements StudentService {

	@Autowired
	private StudentRepository studentRepo;

	@Override
	public List<StudentResponsePage> readAllStudents(int pagesize, int pageno) {

		Pageable pagable = PageRequest.of(pageno, pagesize);
		Page<Student> studentPage = studentRepo.findAll(pagable);
		
		StudentResponsePage studentResponse = new StudentResponsePage();
		
		studentResponse.setTotalElements(studentPage.getTotalElements());
		studentResponse.setSize(studentPage.getSize());
		studentResponse.setTotalPages(studentPage.getTotalPages());
		studentResponse.setLastPage(studentPage.isLast());
			
		
		List<Student> dbStudents = studentRepo.findAll();
		
		List<StudentResponseDto> responses = new ArrayList<>();
		
		for (Student student : dbStudents) {
			StudentResponseDto dto = new StudentResponseDto();
			dto.setFirstName(student.getFirstName());
			dto.setLastName(student.getLastName());
			responses.add(dto);
		}

		return responses;
	}

	@Override
	public StudentResponseDto addNewStudent(StudentRequestDto studentDto) {
		Student student = studentRequestDtoToStudent(studentDto);
		Student dbStudent = studentRepo.save(student);
		return studentToStudentResponseDto(dbStudent);
	}

	private Student studentRequestDtoToStudent(StudentRequestDto studentDto) {
		Student student = new Student();
		student.setFirstName(studentDto.getFirstName());
		student.setLastName(studentDto.getLastName());
		student.setRollNumber(studentDto.getRollNumber());
		student.setAge(studentDto.getAge());
		student.setEmail(studentDto.getEmail());
		return student;
	}

	private StudentResponseDto studentToStudentResponseDto(Student student) {
		StudentResponseDto dto = new StudentResponseDto();
		dto.setFirstName(student.getFirstName());
		dto.setLastName(student.getLastName());
		return dto;
	}

	@Override
	public Optional<Student> readStudentById(int studentId) {
		return studentRepo.findById(studentId);
	}

	@Override
	public List<Student> readStudentsByName(String firstName) {
		return studentRepo.findByFirstName(firstName);
	}

}
